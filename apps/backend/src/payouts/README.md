# Payouts Module

Модуль для автоматической обработки выплат после разрешения рынков.

## Возможности

- ✅ Автоматическая выплата после разрешения рынка
- ✅ Вычет комиссии платформы
- ✅ Поддержка TON Wallet и Telegram Wallet
- ✅ Защита от двойных выплат
- ✅ Полные аудит-логи всех операций

## Архитектура

### PayoutCalculationService

Сервис для расчета выплат с учетом комиссий:

- Расчет выплаты для выигравших ставок (BUY)
- Расчет выплаты для коротких позиций (SELL)
- Расчет возврата для проигравших ставок
- Валидация сумм выплат

### PayoutExecutionService

Сервис для выполнения выплат:

- Внутренние выплаты (зачисление на баланс)
- Внешние выплаты (TON Wallet, Telegram Wallet)
- Автоматическое определение типа выплаты

### PayoutAuditService

Сервис для аудита:

- Логирование создания выплат
- Логирование обработки выплат
- Логирование завершения выплат
- Логирование ошибок
- История аудита

### PayoutsService

Основной сервис:

- Автоматическая обработка выплат после разрешения рынка
- Защита от двойных выплат
- Интеграция с MarketsService

## Поток выплаты

1. **Разрешение рынка**
   - Админ разрешает рынок через `POST /markets/:id/resolve`
   - MarketsService обновляет статус рынка на `resolved`
   - Асинхронно вызывается `PayoutsService.processMarketPayouts()`

2. **Обработка ставок**
   - Находятся все активные ставки на рынке
   - Для каждой ставки определяется, выиграла она или проиграла
   - Проверка на существующую выплату (защита от двойных выплат)

3. **Расчет выплаты**
   - Для выигравшей BUY ставки: `payout = shares - (shares * feeRate)`
   - Для выигравшей SELL ставки: выплата не производится (уже получена при продаже)
   - Для проигравшей ставки: возврат части средств (опционально)

4. **Создание выплаты**
   - Создается запись в таблице `payouts`
   - Статус ставки обновляется на `won` или `lost`
   - Создается аудит-лог

5. **Выполнение выплаты**
   - Определяется тип кошелька (internal/external)
   - Для internal: зачисление на баланс
   - Для external: отправка через провайдера (TON/Telegram Wallet)
   - Обновление статуса выплаты
   - Создание транзакции

## Расчет выплат

### Выигравшая BUY ставка

```
grossPayout = shares (каждая акция стоит 1 при разрешении)
fee = grossPayout * feeRate
netPayout = grossPayout - fee
```

Пример:
- Пользователь купил 100 акций по цене 0.5 TON
- Стоимость ставки: 50 TON
- Комиссия: 5%
- Выплата: 100 - (100 * 0.05) = 95 TON

### Выигравшая SELL ставка

Для SELL ставки на выигравший исход выплата не производится, так как пользователь уже получил выручку при продаже акций.

### Проигравшая ставка

```
refundAmount = betCost * refundRate
```

Пример:
- Стоимость ставки: 50 TON
- Процент возврата: 10%
- Возврат: 50 * 0.1 = 5 TON

## Защита от двойных выплат

1. **Проверка существующей выплаты**
   ```typescript
   const existingPayout = await prisma.payout.findFirst({
     where: {
       betId: bet.id,
       status: { in: ['pending', 'processing', 'completed'] },
     },
   });
   ```

2. **Уникальность по betId**
   - В схеме БД есть индекс на `betId`
   - Логика проверяет наличие активных выплат перед созданием новой

3. **Статусы выплат**
   - `pending` - ожидает обработки
   - `processing` - в процессе
   - `completed` - завершена
   - `failed` - ошибка

## Аудит-логи

Все операции логируются в `admin_audit_logs`:

- `payout_created` - создание выплаты
- `payout_processed` - начало обработки
- `payout_completed` - завершение выплаты
- `payout_failed` - ошибка выплаты

Каждый лог содержит:
- ID выплаты
- ID пользователя
- ID ставки
- Сумму выплаты
- Метаданные (marketId, outcomeId, betType, etc.)
- Временную метку

## API Endpoints

### GET /payouts
Получение выплат пользователя

**Query:**
- `page` - номер страницы (default: 1)
- `limit` - количество на странице (default: 20)

**Response:**
```json
{
  "payouts": [...],
  "total": 100,
  "page": 1,
  "limit": 20,
  "totalPages": 5
}
```

### GET /payouts/:id
Получение одной выплаты

**Response:**
```json
{
  "id": "payout-uuid",
  "userId": "user-uuid",
  "betId": "bet-uuid",
  "amount": "95.00000000",
  "currency": "TON",
  "status": "completed",
  "bet": {...},
  "wallet": {...}
}
```

### GET /payouts/:id/audit
Получение аудит-логов выплаты (только для админов)

**Response:**
```json
[
  {
    "id": "log-uuid",
    "action": "payout_created",
    "resourceType": "payout",
    "resourceId": "payout-uuid",
    "details": {...},
    "createdAt": "2024-01-01T00:00:00Z"
  }
]
```

### POST /payouts/:id/retry
Повторная попытка выплаты (только для админов)

**Response:**
```json
{
  "id": "payout-uuid",
  "status": "completed",
  "processedAt": "2024-01-01T00:00:00Z"
}
```

## Интеграция с MarketsService

После разрешения рынка автоматически вызывается обработка выплат:

```typescript
// В MarketsService.resolve()
this.processPayoutsAsync(marketId, resolvedOutcomeId).catch((error) => {
  console.error(`Failed to process payouts:`, error);
});
```

## Поддержка провайдеров

### Internal Wallet
- Зачисление на внутренний баланс
- Мгновенное выполнение
- Без комиссий провайдера

### TON Wallet
- Отправка через TON API
- Требуется адрес кошелька
- Комиссия сети TON

### Telegram Wallet
- Отправка через Telegram Bot API
- Требуется адрес кошелька
- Комиссия Telegram

## Примеры

### Автоматическая выплата после разрешения

```typescript
// 1. Админ разрешает рынок
POST /markets/:id/resolve
{
  "outcomeId": "outcome-uuid"
}

// 2. Автоматически обрабатываются все ставки
// 3. Создаются выплаты для выигравших ставок
// 4. Выплаты выполняются автоматически
```

### Ручная проверка выплаты

```typescript
GET /payouts/:id

// Проверка статуса и деталей выплаты
```

### Повторная попытка выплаты

```typescript
POST /payouts/:id/retry

// Для failed выплат можно повторить попытку
```

## Безопасность

1. ✅ Защита от двойных выплат
2. ✅ Валидация сумм выплат
3. ✅ Проверка прав доступа
4. ✅ Аудит всех операций
5. ✅ Транзакционная целостность

## Мониторинг

Рекомендуется мониторить:
- Количество выплат в статусе `pending`
- Количество failed выплат
- Среднее время обработки выплат
- Суммы выплат по периодам

