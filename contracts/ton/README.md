# TON Smart Contracts

Smart contracts для платформы прогнозных рынков на TON блокчейне.

## Структура

- `market.fc` - Базовый контракт для управления рынками
- `market-v2.fc` - Расширенная версия с полной поддержкой словарей
- `liquidity-pool.fc` - Контракт для AMM ликвидностных пулов (LMSR и Constant Product)
- `payout.fc` - Контракт для выплат после разрешения рынков
- `market-pool-integration.fc` - Интеграционный слой между Market и Pool контрактами
- `deploy.fif` - Скрипт для деплоя контракта
- `test.fif` - Тестовый скрипт

## Возможности

### Market Contract

- ✅ **Прием ставок** - Пользователи могут размещать ставки на исходы
- ✅ **Принуждение дедлайнов** - Ставки блокируются после дедлайна
- ✅ **Блокировка средств** - Средства блокируются до разрешения рынка
- ✅ **Разрешение рынка** - Администратор может разрешить рынок
- ✅ **Выплата выигрышей** - Победители могут вывести средства
- ✅ **Отмена рынка** - Администратор может отменить рынок с возвратом средств
- ✅ **Комиссии** - Автоматическое взимание комиссий

## Операции контракта

### OP_PLACE_BET (1)
Размещение ставки

**Формат сообщения:**
```
op (32 bits) | query_id (64 bits) | outcome_id (8 bits) | bet_id (64 bits)
```

**Проверки:**
- Рынок должен быть активен
- Дедлайн не должен быть пройден
- Минимальная сумма ставки: 1 TON
- Автоматическое взимание комиссии

**Результат:**
- Средства блокируются в контракте
- Ставка сохраняется в словаре
- Обновляется общая сумма по исходу

### OP_RESOLVE_MARKET (2)
Разрешение рынка (только админ)

**Формат сообщения:**
```
op (32 bits) | query_id (64 bits) | outcome_id (8 bits)
```

**Проверки:**
- Отправитель должен быть администратором
- Рынок не должен быть уже разрешен/отменен
- Дедлайн должен быть пройден

**Результат:**
- Статус рынка меняется на RESOLVED
- Сохраняется выигрышный исход

### OP_WITHDRAW_WINNINGS (3)
Вывод выигрышей

**Формат сообщения:**
```
op (32 bits) | query_id (64 bits) | bet_id (64 bits)
```

**Проверки:**
- Рынок должен быть разрешен
- Ставка должна быть на выигрышный исход
- Ставка не должна быть уже выведена

**Результат:**
- Выплата выигрыша пользователю
- Ставка помечается как выведенная

### OP_CANCEL_MARKET (4)
Отмена рынка (только админ)

**Формат сообщения:**
```
op (32 bits) | query_id (64 bits)
```

**Проверки:**
- Отправитель должен быть администратором
- Рынок не должен быть разрешен

**Результат:**
- Статус рынка меняется на CANCELLED

### OP_REFUND_BETS (5)
Возврат средств (для отмененных рынков)

**Формат сообщения:**
```
op (32 bits) | query_id (64 bits) | bet_id (64 bits)
```

**Проверки:**
- Рынок должен быть отменен
- Ставка должна существовать

**Результат:**
- Возврат суммы ставки пользователю

## Структура данных

### Market Data
```
outcomes_dict (cell) - Словарь исходов -> общая сумма
status (8 bits) - Статус рынка
deadline (64 bits) - Unix timestamp дедлайна
resolved_outcome (8 bits) - ID выигрышного исхода (0 = не разрешен)
total_locked (coins) - Общая заблокированная сумма
admin_address (address) - Адрес администратора
fee_rate (8 bits) - Комиссия в базисных пунктах (200 = 2%)
fee_collector (address) - Адрес для сбора комиссий
bets_dict (cell) - Словарь ставок
```

### Bet Data
```
Key: hash(sender_address, bet_id)
Value: outcome_id (8 bits) | bet_amount (coins) | timestamp (64 bits)
```

## Get Methods

### get_market_info()
Возвращает информацию о рынке:
- status
- deadline
- resolved_outcome
- total_locked
- fee_rate

### can_place_bet()
Проверяет, можно ли разместить ставку:
- Возвращает 1 если можно, 0 если нет

### get_total_locked()
Возвращает общую заблокированную сумму

### get_outcome_total(outcome_id)
Возвращает общую сумму по конкретному исходу

## Компиляция

```bash
# Установка FunC (если еще не установлен)
# См. https://ton.org/docs/develop/smart-contracts/

# Компиляция контракта
func -SPA stdlib.fc market-v2.fc -o market-v2.fif

# Создание .boc файла
fift -s deploy.fif
```

## Деплой

### 1. Подготовка

```bash
# Установите TON CLI tools
# Создайте кошелек для деплоя
toncli deploy
```

### 2. Инициализация контракта

При деплое нужно передать начальные данные:
- `admin_address` - адрес администратора
- `deadline` - Unix timestamp дедлайна
- `fee_rate` - комиссия (например, 200 = 2%)
- `fee_collector` - адрес для сбора комиссий

### 3. Деплой

```bash
toncli deploy market-v2.fc
```

## Использование

### Размещение ставки

```typescript
import { beginCell, Address } from '@ton/core';

const message = beginCell()
  .storeUint(1, 32) // OP_PLACE_BET
  .storeUint(queryId, 64)
  .storeUint(outcomeId, 8)
  .storeUint(betId, 64)
  .endCell();

await contract.send(message, {
  value: betAmount, // в nanoTON
});
```

### Разрешение рынка

```typescript
const message = beginCell()
  .storeUint(2, 32) // OP_RESOLVE_MARKET
  .storeUint(queryId, 64)
  .storeUint(winningOutcomeId, 8)
  .endCell();

await contract.send(message);
```

### Вывод выигрышей

```typescript
const message = beginCell()
  .storeUint(3, 32) // OP_WITHDRAW_WINNINGS
  .storeUint(queryId, 64)
  .storeUint(betId, 64)
  .endCell();

await contract.send(message);
```

## Безопасность

### Проверки

1. **Дедлайн**: Ставки блокируются после дедлайна
2. **Статус рынка**: Ставки принимаются только на активных рынках
3. **Минимальная сумма**: Минимум 1 TON на ставку
4. **Администратор**: Только админ может разрешать/отменять рынки
5. **Двойное использование**: Ставки можно вывести только один раз

### Ограничения

- Комиссия взимается автоматически
- Средства блокируются до разрешения рынка
- Выплаты происходят только после разрешения
- Отмененные рынки позволяют вернуть средства

## Интеграция с Backend

Backend должен:
1. Отслеживать деплой контрактов
2. Мониторить события контрактов
3. Синхронизировать состояние с базой данных
4. Обрабатывать выплаты через контракт

## Тестирование

```bash
# Запуск тестов (требует настройки тестовой среды)
toncli test
```

## Важные замечания

1. **AMM Pricing**: Текущая версия использует упрощенную модель выплат (1:1). В продакшене нужно интегрировать AMM логику из `packages/pricing-engine`.

2. **Gas Optimization**: Контракт оптимизирован для минимального использования газа, но может потребоваться дополнительная оптимизация.

3. **Dictionary Handling**: Используются `udict` для эффективного хранения ставок и исходов.

4. **Error Codes**:
   - 100-199: Ошибки размещения ставок
   - 200-299: Ошибки разрешения рынка
   - 300-399: Ошибки вывода средств
   - 400-499: Ошибки отмены рынка
   - 500-599: Ошибки возврата средств
   - 999: Неизвестная операция

## Дополнительные контракты

### Liquidity Pool Contract

См. `liquidity-pool-README.md` для полной документации по контракту ликвидностных пулов.

**Возможности:**
- LMSR (Logarithmic Market Scoring Rule) модель
- Constant Product (Uniswap-style) модель
- Обработка комиссий
- Управление ликвидностью
- Покупка/продажа акций через AMM

### Payout Contract

См. `payout-README.md` для полной документации по контракту выплат.

**Возможности:**
- Проверка разрешения рынка
- Распределение выигрышей
- Защита от двойных выплат
- Batch выплаты для экономии газа
- Обработка комиссий

### Интеграция

См. `INTEGRATION-GUIDE.md` для руководства по интеграции всех контрактов.

## Дальнейшее развитие

- [ ] Улучшение математических функций в Pool (более точные аппроксимации)
- [ ] Поддержка множественных исходов в Constant Product
- [ ] Оптимизация gas usage
- [ ] Расширенное тестирование
- [ ] Аудит безопасности
- [ ] LP токены как отдельный контракт
