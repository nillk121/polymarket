# Security Considerations for TON Market Contract

## Обзор безопасности

Смарт-контракт для прогнозных рынков должен быть защищен от различных атак и злоупотреблений.

## Реализованные меры безопасности

### 1. Проверка дедлайнов

- ✅ Ставки блокируются после дедлайна
- ✅ Разрешение рынка возможно только после дедлайна
- ✅ Использование `now()` для проверки времени

**Потенциальные риски:**
- Валидаторы могут манипулировать временем (минимально в TON)
- Решение: Использовать блокчейн-время, а не системное

### 2. Проверка статуса рынка

- ✅ Ставки принимаются только на активных рынках
- ✅ Разрешение возможно только на активных/заблокированных рынках
- ✅ Отмена возможна только до разрешения

### 3. Проверка прав администратора

- ✅ Только администратор может разрешать/отменять рынки
- ✅ Проверка адреса отправителя

**Риски:**
- Компрометация приватного ключа администратора
- Решение: Использовать мультисиг или DAO для управления

### 4. Блокировка средств

- ✅ Средства блокируются в контракте
- ✅ Выплаты только после разрешения
- ✅ Защита от двойного вывода

### 5. Минимальная сумма ставки

- ✅ Проверка минимальной суммы (1 TON)
- ✅ Защита от спама и злоупотреблений

## Потенциальные уязвимости

### 1. Reentrancy

**Риск:** Низкий (TON использует асинхронную модель)
**Защита:** 
- Проверки выполняются до отправки сообщений
- Состояние обновляется до отправки

### 2. Integer Overflow/Underflow

**Риск:** Средний
**Защита:**
- Использование встроенных функций TON
- Проверка балансов перед операциями

### 3. Front-running

**Риск:** Средний
**Защита:**
- Использование query_id для уникальности
- Проверка дедлайнов

### 4. DoS через газ

**Риск:** Низкий (газ в TON дешевый)
**Защита:**
- Минимальная сумма ставки
- Ограничение сложности операций

## Рекомендации по улучшению

### 1. Мультисиг для администратора

```func
;; Использование мультисиг контракта для управления
const int MULTISIG_THRESHOLD = 3;
const int MULTISIG_TOTAL = 5;
```

### 2. Временные блокировки

```func
;; Добавить временную блокировку после разрешения
const int WITHDRAWAL_DELAY = 86400; ;; 24 часа
```

### 3. Лимиты на ставки

```func
;; Максимальная сумма ставки
const int MAX_BET_AMOUNT = 1000000000000; ;; 1000 TON
```

### 4. Rate limiting

```func
;; Ограничение количества ставок от одного адреса
const int MAX_BETS_PER_ADDRESS = 100;
```

## Аудит

Перед деплоем в mainnet рекомендуется:

1. **Формальная верификация** - Проверка логики контракта
2. **Тестирование** - Полное покрытие тестами
3. **Аудит безопасности** - Профессиональный аудит
4. **Тестнет тестирование** - Тестирование на testnet

## Мониторинг

После деплоя необходимо:

1. Мониторить все транзакции контракта
2. Отслеживать аномальную активность
3. Регулярно проверять баланс контракта
4. Логировать все операции

## Обновление контракта

TON поддерживает обновление контрактов через:
- Proxy контракты
- Версионирование
- Миграция данных

Рекомендуется использовать proxy паттерн для возможности обновления.

