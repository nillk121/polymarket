# Математические формулы AMM Pricing Engine

## LMSR (Logarithmic Market Scoring Rule)

### Основные формулы

#### Цена исхода i

```
p_i = exp(q_i / b) / Σ(exp(q_j / b))
```

где:
- `p_i` - цена исхода i (вероятность, 0 ≤ p_i ≤ 1)
- `q_i` - количество акций исхода i
- `b` - параметр ликвидности (liquidity)
- `exp` - экспоненциальная функция
- `Σ` - сумма по всем исходам j

#### Стоимость покупки x акций исхода i

```
Cost(x) = b * ln(Σ(exp((q_j + δ_ij * x) / b))) - b * ln(Σ(exp(q_j / b)))
```

где:
- `δ_ij` - дельта Кронекера (1 если i == j, иначе 0)
- `ln` - натуральный логарифм

#### Выручка от продажи x акций исхода i

```
Revenue(x) = b * ln(Σ(exp(q_j / b))) - b * ln(Σ(exp((q_j - δ_ij * x) / b)))
```

### Свойства LMSR

1. **Сумма вероятностей = 1**: Σ(p_i) = 1
2. **Монотонность**: Больше акций → выше цена
3. **Ликвидность**: Параметр b контролирует чувствительность цены к объему
4. **Бесконечная ликвидность**: При b → ∞, цены становятся равномерными

### Пример расчета

Для binary рынка с:
- `b = 1000`
- `q_1 = 100` (Yes)
- `q_2 = 100` (No)

```
p_1 = exp(100/1000) / (exp(100/1000) + exp(100/1000))
   = exp(0.1) / (exp(0.1) + exp(0.1))
   = 1.105 / (1.105 + 1.105)
   = 0.5
```

## Constant Product (Uniswap-style)

### Основные формулы

#### Инвариант

```
Π(R_i) = k
```

где:
- `R_i` - резерв исхода i
- `k` - константа (инвариант)
- `Π` - произведение по всем исходам

#### Цена исхода i

```
p_i = R_i / Σ(R_j)
```

где:
- `p_i` - цена исхода i
- `R_i` - резерв исхода i
- `Σ(R_j)` - сумма резервов всех исходов

#### Стоимость покупки x акций исхода i (binary рынок)

Для binary рынка с двумя исходами:

```
(R_1 + x) * (R_2 - cost) = R_1 * R_2
```

Решая относительно cost:

```
cost = R_2 - (R_1 * R_2) / (R_1 + x)
```

#### Выручка от продажи x акций исхода i (binary рынок)

```
(R_1 - x) * (R_2 + revenue) = R_1 * R_2
```

Решая относительно revenue:

```
revenue = (R_1 * R_2) / (R_1 - x) - R_2
```

### Свойства Constant Product

1. **Инвариант**: Произведение резервов постоянно
2. **Ликвидность**: Чем больше резервы, тем меньше проскальзывание
3. **Симметрия**: Формула симметрична относительно исходов

### Пример расчета

Для binary рынка с:
- `R_1 = 100` (Yes)
- `R_2 = 100` (No)
- Покупка `x = 10` акций Yes

```
k = 100 * 100 = 10000
cost = 100 - (100 * 100) / (100 + 10)
     = 100 - 10000 / 110
     = 100 - 90.91
     = 9.09
```

## Проскальзывание (Slippage)

### Формула

```
slippage = (execution_price - current_price) / current_price * 100%
```

где:
- `current_price` - текущая цена до операции
- `execution_price` - фактическая цена исполнения

### Максимальная/минимальная цена

```
max_price = current_price * (1 + max_slippage / 100)
min_price = current_price * (1 - max_slippage / 100)
```

## Комиссии

### Формула комиссии

```
fee = amount * fee_rate
```

где:
- `amount` - сумма операции
- `fee_rate` - ставка комиссии (0 ≤ fee_rate ≤ 1)

### Сумма после комиссии

```
net_amount = amount - fee
            = amount * (1 - fee_rate)
```

### Сумма с учетом комиссии

Если нужна определенная сумма после комиссии:

```
gross_amount = net_amount / (1 - fee_rate)
```

## Сравнение моделей

| Параметр | LMSR | Constant Product |
|----------|------|------------------|
| Ликвидность | Параметр b | Резервы R_i |
| Сложность | O(n) | O(n) |
| Проскальзывание | Зависит от b | Зависит от резервов |
| Применение | Prediction markets | DEX (Uniswap) |
| Преимущества | Гарантированная ликвидность | Простота, проверенность |

## Рекомендации

### Выбор модели

- **LMSR**: Для prediction markets (как Polymarket)
  - Гарантированная ликвидность
  - Лучше для binary рынков
  - Параметр b должен быть достаточно большим (1000+)

- **Constant Product**: Для DEX или простых рынков
  - Проще понять
  - Требует начальной ликвидности
  - Лучше для multi-исходных рынков

### Настройка параметров

**LMSR:**
- `b = 1000` - для небольших рынков
- `b = 10000` - для крупных рынков
- Больше b = меньше проскальзывание, но медленнее изменение цены

**Constant Product:**
- Начальные резервы должны быть равны для равномерного распределения
- Минимум 100 единиц на исход для достаточной ликвидности

